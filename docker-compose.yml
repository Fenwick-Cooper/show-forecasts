services:
  webapp:
    image: ${WEBAPP_IMAGE_NAME:-icpac/cgan-ui}
    container_name: ${WEBAPP_CNTR_NAME:-cgan-ui}
    build:
      context: .
      dockerfile: ${WEBAPP_DOCKERFILE:-Dockerfile}
      args:
        APP_DIR: ${APP_DIR:-/code}
        APP_STORE_DIR: ${APP_STORE_DIR:-/code/store}
        APP_USER_ID: ${APP_USER_ID:-10010}
        APP_GROUP_ID: ${APP_GROUP_ID:-10010}
        WORK_HOME: ${WORK_HOME:-/opt/cgan}
    restart: ${RESTART_POLICY:-always}
    # entrypoint: ${APP_DIR:-/code}/entrypoint.sh
    command: bash ${APP_DIR:-/code}/entrypoint.sh
    env_file:
      - ${MERCURY_ENV_FILE:-.env}
    depends_on:
      - uidb
    volumes:
      - ${CGAN_DATA_STORE:-./data/store}:${APP_STORE_DIR:-/code/store}
      - ${MERCURY_STATIC:-./data/static}:${WORK_HOME:-/opt/app}/mercury/django_static
      - ${MERCURY_MEDIA:-./data/media}:${WORK_HOME:-/opt/app}/mercury/media

  nginx:
    build:
      context: .
      dockerfile: ./nginx/Dockerfile
    image: ${NGINX_IMAGE_NAME:-icpac/mercury-nginx}
    container_name: ${NGINX_CNTR_NAME:-mercury-nginx}
    restart: ${RESTART_POLICY:-always}
    ports:
      - ${HOST_NET_IP:-172.17.0.1}:${APP_HOST_PORT:-4050}:80
    volumes:
      - ${MERCURY_STATIC:-./data/static}:/app/mercury/static
      - ${MERCURY_MEDIA:-./data/media}:/app/mercury/media
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - webapp
    command: '/bin/sh -c ''nginx -g "daemon off;"'''

  uidb:
    image: postgres:alpine
    container_name: ${UI_DB_CNTR_NAME:-ui-pgdb}
    restart: ${RESTART_POLICY:-always}
    volumes:
      - ./data/pgdata:/var/lib/postgresql/data/
    environment:
      - TZ={TZ:-Africa/Nairobi}
      - POSTGRES_DB=${POSTGRES_DB:-cgan_ui_db}
      - POSTGRES_USER=${POSTGRES_USER:-climcast}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-z7ZAWxzUPtmh2qoA}
